-- === SkrilyaHub Main Script ===
wait(4)

-- === Конфигурация ===
-- Дефолтные значения
local config = {
    AutoStartStory        = {"S", 1, 1, 1},    -- {Mode, Level, Difficulty}
    KillAura = {
        OffsetY     = 0,
        HoverRadius = 5,
        HoverSpeed  = 2,
    },
    RestartIfNoMobsAfter  = 3,            -- секунд до перезапуска, если мобов нет
    RestartOnTimerEnd     = true,         -- рестарт при достижении таймера 0:00
    KeyUse = {                           -- последовательность нажатий
        {Enum.KeyCode.ButtonX, 4},
        {Enum.KeyCode.Z,       1},
        {Enum.KeyCode.ButtonX, 4},
        {Enum.KeyCode.ButtonX, 1},
        {Enum.KeyCode.ButtonX, 4},
        {Enum.KeyCode.C,       1},
    },
    AutoReplay            = true,         -- автоматическое повторение
    AutoNext              = false,        -- перейти к следующему уровню
}

-- Переопределение из getgenv().UserConfig
if getgenv().UserConfig then
    for k, v in pairs(getgenv().UserConfig) do
        if typeof(v) == "table" and typeof(config[k]) == "table" then
            for subKey, subVal in pairs(v) do
                config[k][subKey] = subVal
            end
        else
            config[k] = v
        end
    end
end

-- Получаем сервисы
local Players           = game:GetService("Players")
local HttpService       = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService      = game:GetService("TweenService")
local RunService        = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- Переменные игрока и GUI
local player    = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local placeId   = game.PlaceId

-- === Создаём свой ScreenGui ===
local gui = Instance.new("ScreenGui")
gui.Name           = "SkrilyaHubOverlay"
gui.ResetOnSpawn   = false
gui.IgnoreGuiInset = true
gui.Parent         = playerGui

local blackFrame = Instance.new("Frame")
blackFrame.Size            = UDim2.new(1,0,1,0)
blackFrame.Position        = UDim2.new(0,0,0,0)
blackFrame.BackgroundColor3= Color3.new(0,0,0)
blackFrame.BorderSizePixel = 0
blackFrame.Parent          = gui

local listLayout = Instance.new("UIListLayout")
listLayout.SortOrder           = Enum.SortOrder.LayoutOrder
listLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
listLayout.VerticalAlignment   = Enum.VerticalAlignment.Center
listLayout.Padding             = UDim.new(0,10)
listLayout.Parent              = blackFrame

local title = Instance.new("TextLabel")
title.Size                   = UDim2.new(1,0,0,60)
title.BackgroundTransparency = 1
title.Text                   = "SkrilyaHub"
title.TextColor3             = Color3.new(1,1,1)
title.Font                   = Enum.Font.GothamBlack
title.TextScaled             = true
title.LayoutOrder            = 1
title.Parent                 = blackFrame

local toggleBtn = Instance.new("TextButton")
toggleBtn.Name                   = "ToggleBlackScreenButton"
toggleBtn.Size                   = UDim2.new(0,180,0,40)
toggleBtn.Position               = UDim2.new(0.5,-90,1,-50)
toggleBtn.AnchorPoint            = Vector2.new(0.5,0)
toggleBtn.BackgroundColor3       = Color3.fromRGB(50,50,50)
toggleBtn.BorderSizePixel        = 0
toggleBtn.BackgroundTransparency = 0.2
toggleBtn.Text                   = "On/Off Black Screen"
toggleBtn.Font                   = Enum.Font.GothamBold
toggleBtn.TextSize               = 18
toggleBtn.TextColor3             = Color3.new(1,1,1)
toggleBtn.Parent                 = gui

local isBlackVisible = true
toggleBtn.MouseButton1Click:Connect(function()
    isBlackVisible = not isBlackVisible
    blackFrame.Visible = isBlackVisible
end)
toggleBtn.MouseEnter:Connect(function()
    toggleBtn.BackgroundTransparency = 0
end)
toggleBtn.MouseLeave:Connect(function()
    toggleBtn.BackgroundTransparency = 0.2
end)

local orderCounter = 2
local function addGrayText(text)
    local lbl = Instance.new("TextLabel")
    lbl.Size                   = UDim2.new(1,-40,0,25)
    lbl.BackgroundTransparency = 1
    lbl.Text                   = text
    lbl.TextColor3             = Color3.fromRGB(180,180,180)
    lbl.Font                   = Enum.Font.Gotham
    lbl.TextSize               = 20
    lbl.TextXAlignment         = Enum.TextXAlignment.Center
    lbl.LayoutOrder            = orderCounter
    lbl.Parent                 = blackFrame
    orderCounter = orderCounter + 1
end

local function safeGet(path)
    local ok,val = pcall(function() return path.Text end)
    return ok and val or "N/A"
end

-- Конфиг сохранения/загрузки (если нужно)
local configName = "SkrilyaHub_Config.json"

if placeId == 17850641257 then
    -- 1) Сохраняем Gems/Gold/Trait
    local function getInventoryCountByName(targetName)
        local window = playerGui:FindFirstChild("Window")
        if not window then return "N/A" end
    
        local inventory = window:FindFirstChild("Inventory")
        if not inventory then return "N/A" end
    
        local frame4 = inventory.Frame and inventory.Frame:FindFirstChild("Frame4")
        if not frame4 then return "N/A" end
    
        local frame1 = frame4:FindFirstChild("Frame1")
        if not frame1 then return "N/A" end
    
        local scrolling = frame1:FindFirstChild("Scrolling")
        if not scrolling then return "N/A" end
    
        for _, item in ipairs(scrolling:GetChildren()) do
            if item:IsA("Frame") then
                local block = item:FindFirstChild("Frame")
                if block then
                    local nameLabel = block:FindFirstChild("BlockName")
                    if nameLabel and nameLabel:IsA("TextLabel") and nameLabel.Text == targetName then
                        local numLabel = block:FindFirstChild("Number")
                        if numLabel and numLabel:IsA("TextLabel") then
                            return numLabel.Text
                        end
                    end
                end
            end
        end
    
        return "N/A"
    end

    -- === Безопасное получение текста из вложенного элемента UI ===
    local function safeGetText(...)
        local args = {...}
        local parent = table.remove(args, 1)
        for i, name in ipairs(args) do
            if not parent or not parent:FindFirstChild(name) then
                return "N/A"
            end
            parent = parent[name]
        end
        if parent:IsA("TextLabel") or parent:IsA("TextButton") or parent:IsA("TextBox") then
            return parent.Text
        else
            return "N/A"
        end
    end

    local data = {
        Gems        = safeGetText(playerGui, "ScreenGui", "Frame", "Gems", "Gems", "TextLabel"),
        Gold        = safeGetText(playerGui, "ScreenGui", "Frame", "Gems", "Gold", "TextLabel"),
        Ticket      = getInventoryCountByName("Ticket"),
        TraitReroll = getInventoryCountByName("Trait Reroll"),
    }
    writefile(configName, HttpService:JSONEncode(data))
    addGrayText("Gems: "  .. data.Gems)
    addGrayText("Gold: "  .. data.Gold)
    addGrayText("Trait Reroll: " .. data.TraitReroll)
    addGrayText("Tickets: "      .. data.Ticket)
    addGrayText("Config saved")

    -- 2) Запускаем автостарт + Ready спустя 2 секунды
    task.delay(2, function()
        local function AutoStartAndReady()
            -- Вычисляем текст режима по config.AutoStartStory[1]
            local modeKey  = config.AutoStartStory[1]
            local modeMap  = { S = "Story", R = "Raid", I = "Inf", Inf = "Inf", Infinity = "Inf" }
            local modeText = modeMap[tostring(modeKey)] or tostring(modeKey)

            -- a) Создаём комнату
            local argsCreate = {
                [1] = "Create",
                [2] = modeText,
                [3] = config.AutoStartStory[2],
                [4] = config.AutoStartStory[3],
                [5] = config.AutoStartStory[4],
                [6] = true,
            }
            ReplicatedStorage.Event.JoinRoom:FireServer(unpack(argsCreate))
            task.wait(0.5)

            -- b) Телепортируемся
            local argsTeleport = {
                [1] = "TeleGameplay",
                [2] = modeText,
                [3] = config.AutoStartStory[2],
                [4] = config.AutoStartStory[3],
                [5] = config.AutoStartStory[4],
                [6] = true,
            }
            ReplicatedStorage.Event.JoinRoom:FireServer(unpack(argsTeleport))

            -- c) Ждём RoomUi и нажимаем Ready
            local roomUi = playerGui:WaitForChild("RoomUi", 10)
            if not roomUi then
                warn("[SkrilyaHub] RoomUi не появился")
                return
            end
            local readyFrame = roomUi:FindFirstChild("Ready")
            if readyFrame and readyFrame.Frame and readyFrame.Frame:FindFirstChild("StartButton") then
                local btn = readyFrame.Frame.StartButton
                local ls  = btn:FindFirstChild("Butom") and btn.Butom:FindFirstChild("LocalScript")
                local ev  = ls and ls:FindFirstChild("RemoteEvent")
                if ev then ev:FireServer() end
            end
        end

        AutoStartAndReady()
    end)
else
        -- === Безопасное получение текста из вложенного элемента UI ===
    local function safeGetText(...)
        local args = {...}
        local parent = table.remove(args, 1)
        for i, name in ipairs(args) do
            if not parent or not parent:FindFirstChild(name) then
                return "N/A"
            end
            parent = parent[name]
        end
        if parent:IsA("TextLabel") or parent:IsA("TextButton") or parent:IsA("TextBox") then
            return parent.Text
        else
            return "N/A"
        end
    end

    -- Здесь загрузка конфиг-файла для любых других placeId
    if isfile(configName) then
        local loaded = HttpService:JSONDecode(readfile(configName))
        addGrayText("Loaded from config:")
        addGrayText("Gems: "  .. (loaded.Gems or "N/A"))
        addGrayText("Gold: "  .. (loaded.Gold or "N/A"))
        addGrayText("Trait Reroll: " .. (loaded.TraitReroll or "N/A"))
        addGrayText("Tickets: "      .. (loaded.Ticket or "N/A"))
    else
        addGrayText("Config not found")
    end
end

-- === Auto kill aura + авто-перезапуск или Next ===
local character = player.Character or player.CharacterAdded:Wait()
local hrp       = character:WaitForChild("HumanoidRootPart")

-- читаем из конфига
local offsetY       = config.KillAura.OffsetY
local hoverRadius   = config.KillAura.HoverRadius
local hoverSpeed    = config.KillAura.HoverSpeed
local restartInterval = config.RestartIfNoMobsAfter

-- Нажимаем Ready с максимум 3 попыток, затем пропускаем
do
    local attempts = 0
    local success = false

    while attempts < 3 do
        attempts = attempts + 1

        -- Проверяем, что GUI точно существует
        local roomUi = playerGui:FindFirstChild("RoomUi")
        local readyFrame = roomUi and roomUi:FindFirstChild("Ready")
        local btn = readyFrame and readyFrame.Frame and readyFrame.Frame:FindFirstChild("StartButton")
        local ls  = btn and btn:FindFirstChild("Butom") and btn.Butom:FindFirstChild("LocalScript")
        local ev  = ls and ls:FindFirstChild("RemoteEvent")

        if ev then
            local ok, err = pcall(function()
                ev:FireServer()
            end)
            if ok then
                success = true
                break
            end
        end

        -- Если не получилось, ждём секунду и пробуем снова
        task.wait(2)
    end

    if not success then
        warn("[SkrilyaHub] Не удалось нажать кнопку Ready после 3 попыток, пропуск...")
    end
end

-- создаём «платформу» под игроком
local platform = Instance.new("Part")
platform.Size        = Vector3.new(15,1,15)
platform.Anchored    = true
platform.CanCollide  = false
platform.Transparency= 0.5
platform.Parent      = workspace
RunService.Heartbeat:Connect(function()
    platform.CFrame = hrp.CFrame * CFrame.new(0, -2, 0)
end)

-- поиск ближайшего моба
local function getClosestMob()
    for _, mob in ipairs(workspace.Enemy.Mob:GetChildren()) do
        if mob:IsA("Model")
        and mob:FindFirstChild("Humanoid")
        and mob.Humanoid.Health > 0
        and mob:FindFirstChild("HumanoidRootPart") then
            return mob
        end
    end
    return nil
end

-- полёт к цели
local function flyToTarget(pos, duration)
    return TweenService:Create(hrp, TweenInfo.new(duration, Enum.EasingStyle.Sine), {
        CFrame = CFrame.new(pos.X, hrp.Position.Y, pos.Z)
    })
end

-- зависание над мобом
local function hoverAbove(targetPart, stopSignal)
    local angle = 0
    return RunService.Heartbeat:Connect(function(dt)
        if stopSignal.stop then return end
        angle = angle + dt * hoverSpeed
        local x = math.cos(angle) * hoverRadius
        local z = math.sin(angle) * hoverRadius
        hrp.CFrame = CFrame.new(targetPart.Position + Vector3.new(x, offsetY, z), targetPart.Position)
    end)
end

-- нажатие клавиш по конфигу
local function pressKey(keyCode, duration)
    VirtualInputManager:SendKeyEvent(true, keyCode, false, nil)
    task.wait(duration or 0.1)
    VirtualInputManager:SendKeyEvent(false, keyCode, false, nil)
end

local function pressKeysSequence()
    while true do
        for _, keyData in ipairs(config.KeyUse) do
            for i = 1, keyData[2] do
                pressKey(keyData[1])
                task.wait(0.1)
            end
        end
        task.wait(0.5)
    end
end
task.spawn(pressKeysSequence)

local function checkRaidTime()
    local minVal = workspace.Sytem.Time.Min.Value
    local secVal = workspace.Sytem.Time.Sec.Value
    
    -- Время закончилось, если минуты и секунды равны нулю
    return (minVal == 0 and secVal == 0)
end

-- главный цикл фарма
task.spawn(function()
    local noMobsTime = 0

    while true do
        local mob = getClosestMob()

        if mob then
            -- Сбрасываем счётчик, когда mob найден
            noMobsTime = 0

            -- Полёт к мобу и убийство
            local flyTween = flyToTarget(mob.HumanoidRootPart.Position, 1.5)
            flyTween:Play()
            flyTween.Completed:Wait()

            local stopSignal = { stop = false }
            local hoverConn  = hoverAbove(mob.HumanoidRootPart, stopSignal)

            -- Ждём, пока моб жив
            repeat
                task.wait(0.2)
            until mob.Humanoid.Health <= 0 or not mob.Parent

            -- останавливаем hover
            stopSignal.stop = true
            hoverConn:Disconnect()

            -- Infinity: после убийства сразу шлём команду на спавн следующего босса
            local modeKey = tostring(config.AutoStartStory[1]):upper()
            if modeKey == "I" or modeKey == "INF" or modeKey == "INFINITY" then
                -- ждём, что RoomUi и NextF появятся (таймаут 5 секунд)
                local roomUi = player.PlayerGui:WaitForChild("RoomUi", 5)
                local nextF  = roomUi and roomUi:WaitForChild("NextF", 5)
                if nextF then
                    -- внутри NextF: Frame → StartButton → Ready → LocalScript → RemoteEvent
                    local ok, err = pcall(function()
                        nextF.Frame
                             .StartButton
                             .Ready
                             .LocalScript
                             .RemoteEvent
                             :FireServer()
                    end)
                    if not ok then
                        warn("[SkrilyaHub] Не удалось вызвать NextF.RemoteEvent:", err)
                    end
                else
                    warn("[SkrilyaHub] Infinity mode: NextF GUI не появился за 5 секунд")
                end
            end


        else
            -- считаем, сколько секунд нет мобов
            noMobsTime = noMobsTime + 0.2
        end
        
        local timeUp = config.RestartOnTimerEnd and checkRaidTime()
        
        -- Проверяем либо/либо
        local shouldRestart = false
        
        if config.RestartOnTimerEnd then
            -- Только по окончанию таймера
            shouldRestart = timeUp
        else
            -- Только по отсутствию мобов
            shouldRestart = noMobsTime >= config.RestartIfNoMobsAfter
        end
        
        if shouldRestart then
            warn(string.format(
                "[SkrilyaHub] Триггер рестарта: noMobsTime=%.1f, timeUp=%s",
                noMobsTime, tostring(timeUp)
            ))

            -- Выполняем Next или Replay в зависимости от конфига
            local remote = ReplicatedStorage.Events.WinEvent.Buttom
            if remote and remote:IsA("RemoteEvent") then
                if config.AutoNext then
                    remote:FireServer("NextLv")
                elseif config.AutoReplay then
                    remote:FireServer("RPlay")
                end
            else
                warn("[SkrilyaHub] RemoteEvent 'Buttom' не найден!")
            end

            -- Сбрасываем счётчик отсутствия мобов
            noMobsTime = 0
        end

        task.wait(0.2)
    end
end)


-- Удаление текстур и декалей
local function removeTextures(root)
    for _, c in pairs(root:GetDescendants()) do
        if c:IsA("Texture") or c:IsA("Decal") then
            c:Destroy()
        end
    end
end

local function simplifyToGrayCubes(root)
    for _, obj in pairs(root:GetDescendants()) do
        if obj:IsA("Texture") or obj:IsA("Decal") or obj:IsA("SurfaceAppearance") then
            obj:Destroy()
        elseif obj:IsA("SpecialMesh") or obj:IsA("FileMesh") or obj:IsA("MeshPart") then
            if obj:IsA("MeshPart") then
                local cube = Instance.new("Part")
                cube.Size       = obj.Size
                cube.CFrame     = obj.CFrame
                cube.Anchored   = obj.Anchored
                cube.CanCollide = obj.CanCollide
                cube.Parent     = obj.Parent
                obj:Destroy()
            else
                obj:Destroy()
            end
        elseif obj:IsA("BasePart") then
            obj.Material    = Enum.Material.Plastic
            obj.Color       = Color3.fromRGB(128, 128, 128)
            obj.Reflectance = 0
            obj.Transparency= 0
            obj.Shape       = Enum.PartType.Block
        end
    end
end

removeTextures(workspace)
simplifyToGrayCubes(workspace)

print("[SkrilyaHub] Конфигурация загружена успешно.")
